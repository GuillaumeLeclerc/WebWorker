function WebWorker(a){"use strict";var b=this,c=!1,d=!1,e={},f=0,g=-1;EventEmitter.call(b),b.script=a||"simulate.js",b.state="loading",b.worker=new Worker(WebWorker.libPath+"workerCode.js"),b.taskQueue=[];var h=function(a,c){var d=[a];"undefined"!=typeof c&&d.push(c),b.worker.postMessage(d)},i=function(){return++f},j=function(){b.state="preloaded",h("load",WebWorker.workersPath+b.script)},k=function(){d=!1},l=function(){b.state="ready",g=-1,b.isReady()?b.emitEvent("ready",[b]):s()},m=function(a){b.emitEvent("resultAvailable",[a]),k(),l()},n=function(a){"busy"!==b.state?(b.state="error",b.emitEvent("error",[a])):(b.emitEvent("runError",[a]),k(),l())},o=function(a){b.emitEvent("progress",[a])},p=function(){d=!0,q()};b.terminate=function(){b.worker.terminate(),b.state="terminated"};var q=function(){for(;d&&e[g]&&e[g].length>0;){var a=e[g].shift();h(a.name,a.data)}},r=function(a,b,c){e[a]=e[a]||[],e[a].push({name:"custom-"+b,data:c}),q()};b.book=function(){c=!0},b.isReady=function(){return"ready"===b.state&&0===b.taskQueue.length&&!c},b.worker.addEventListener("message",function(a){var c=a.data,d=c[0],e=c[1];switch(d){case"error":n(e);break;case"preloaded":j();break;case"loaded":l();break;case"startWorking":b.state="busy";break;case"progress":o(e);break;case"finishedWorking":m(e);break;case"eventsRegistered":p();break;default:b.emitEvent(d,[e])}});var s=function(){if("ready"===b.state&&0!==b.taskQueue.length){b.state="busy";var a=b.taskQueue.shift(),c=a.work,d=a.defered,e=a.progressCallback,f=a.methodName,i=a.id;g=i,h("work",[f,c]),"function"==typeof e&&b.addListener("progress",e),b.addOnceListener("resultAvailable",function(a){"function"==typeof e&&b.removeListener("progress",e),d.resolve(a)}),b.addOnceListener("runError",function(a){b.removeListener("progress",e),d.reject(a)})}};b.doWork=function(a,d,e){c=!1;var f=i(),g=Q.defer(),h={id:f,methodName:a,work:d,progressCallback:e,defered:g};b.taskQueue.push(h),s();var j=g.promise;return j.sendEvent=function(a,b){r(f,a,b)},j}}function WorkerPool(a,b,c){"use strict";var d=this;if("number"!=typeof a||"number"!=typeof b||"string"!=typeof c)throw"Invalid arguments";var e=[];d.workers=e;for(var f=[],g=function(){for(;f.length>0&&j();){var a=f.shift(),b=j();b.book(),a.resolve(b)}},h=function(a){var b=a+"Batch";"undefined"==typeof d[a]&&(d[a]=d.doWork.bind(this,a)),"undefined"==typeof d[b]&&(d[b]=d.doWorkBatch.bind(this,a))},i=function(){var a=new WebWorker(c);return a&&(a.addListener("ready",g),a.addListener("methodAvailable",h),e.push(a)),a},j=function(){for(var a in e)if(e[a].isReady())return e[a];return void 0},k=function(){var a=Q.defer(),c=j();return c?(c.book(),a.resolve(c),a.promise):e.length<b&&(c=i())?(c.book(),a.resolve(c),a.promise):(f.push(a),a.promise)},l=0;a>l;++l)i();d.terminate=function(){for(var a in e)e[a].terminate()},d.doWork=function(){var a=arguments,b=[],c=null,d=k().then(function(d){for(c=d.doWork.apply(d,a);b.length>0;){var e=b.shift();c.sendEvent(e.name,e.data)}return c}).fail(function(a){throw a});return d.sendEvent=function(a,d){null===c?b.push({name:a,data:d}):c.sendEvent(a,d)},d},d.doWorkBatch=function(a,b,c){var e=[];for(var f in b){var g=d.doWork(a,b[f],c);e.push(g)}return Q.all(e)}}WebWorker.libPath="workers/",WebWorker.workersPath="workers/",WebWorker.prototype=Object.create(EventEmitter.prototype),WebWorker.prototype.constructor=WebWorker;